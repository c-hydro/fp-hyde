Annex B - Rainfarm
==================

Rainfarm belongs to the family of metagaussian models and it is based on a nonlinear transformation of a linearly correlated process. This approach is closely related to the Turning Bands Method and has been used both for satellite-based rainfall measurement validation and for stochastic rainfall modelling.

The model is able to generate small-scale rainfall fields that take into account not only the total amount of precipitation predicted by the meteorological model but also its linear correlation structure and the position of the main rainfall patterns. Due to the straightforward link between the model parameters and the large-scale field, this model is suitable for operational downscaling procedures.

.. figure:: img/hyde_rfarm/rfarm_example_horizontal.png
    :height: 500px
    :width: 1000px
    :scale: 50 %
    :alt: example of Rainfarm application.
    :align: center

    Time average of the original, LAM field panel (a) and of one realization of the stochastic field generated by the Rainfarm panel (b). The values indicate the average precipitation in mm/h.


Rainfarm uses the spectral information of large-scale meteorological predictions and generates fine resolution precipitation fields by propagating this information to smaller scales. The basic idea is to reconstruct the Fourier spectrum of the small-scale precipitation field by preserving the LAM information at the scales where we are confident in the meteorological prediction. The rainfall field is seen as the superposition of a finite number of harmonics with amplitudes decreasing as spatial and temporal scales become smaller. For a given realization (the predicted field at hand) the harmonics at large scales are assumed to be well predicted by the meteorological model, and should be preserved. A major concern is to figure out which are the scales below which the forecasted fields are considered to be unreliable.

.. table:: Summary of the model Rainfarm parameters
    :widths: auto

    +-----------+--------------------------------+
    | Parameter |           Description          |
    +-----------+--------------------------------+
    |:math:`L_0`| Reliable spatial scale of LAM  |
    +-----------+--------------------------------+
    |:math:`T_0`| Reliable temporal scale of LAM |
    +-----------+--------------------------------+

As shown in the previous section, the Rainfarm model has four free parameters, named :math:`L_0`, :math:`T_0`, :math:`\alpha` and :math:`\beta`. :math:`L_0` and :math:`T_0` represent the spatial and temporal resolutions at which the precipitation prediction is considered reliable and they should be fixed by the user depending on the numerical model considered. The spectral parameters :math:`\alpha` and :math:`\beta` are estimated in real-time from the LAM power spectrum. The RainFARM works as follows. The aggregation of the LAM field on spatial and temporal scales :math:`L_0` and :math:`T_0`, generates the starting field, called :math:`P`. From this coarse-grained prediction RainFARM produces downscaled fields by following these steps:

    1. Computation of the Fourier transform of the coarse-grained LAM-predicted field :math:`P(X, Y, T)`.   This procedure generates a spatial-temporal Fourier spectrum :math:`\dot{P}(K_X, K_Y, \Omega)` defined as follows:

    .. figure:: img/hyde_rfarm/rfarm_eq1.png
        :alt: Rainfarm equation 1.
        :align: center

    Where :math:`D_X`, :math:`D_Y` and :math:`D_T` are the domain sizes in space and time respectively. Here, :math:`D_X`, :math:`D_Y` are the wave numbers in the X and Y directions and :math:`\Omega` is the angular frequency. Clearly, :math:`K_X, K_Y <= \pi/L_0` and :math:`\Omega <= \pi/T_0`, where :math:`\pi/L_0` is the Nyquist wavenumber and :math:`\pi/T_0` is the Nyquist frequency of the field to be downscaled.

    2. Estimate of the space-time power spectrum :math:`\vert{\dot{P}(K_X, K_Y, \Omega)^2}\vert` of the aggregated LAM field :math:`P` as the square of the modulus of its Fourier transform :math:`\hat{P}`.

    3. Extrapolation of the power spectrum :math:`\vert{\hat{P}^2}\vert` to small scales. To do so, we assume the power spectrum of the rainfall field to have an approximate power-law behavior, consistent with the outcome of several analyses on the structure of precipitation fields. The procedure estimates the spatial and temporal logarithmic slopes (:math:`\alpha` and :math:`\beta` respectively) of the LAM power spectrum, :math:`\vert{\hat{P}}\vert`. For simplicity, we assume isotropy in the two spatial directions.

    4. Generation of a Fourier spectrum :math:`\hat{g}(k_x, k_y, \omega)`, defined as:

    .. figure:: img/hyde_rfarm/rfarm_eq2.png
        :alt: Rainfarm equation 2.
        :align: center

    where :math:`\theta(k_x, k_y, \omega)` are random, uniformly distributed phases. The wavenumbers (:math:`K_x)` and :math:`k_y`) and the frequency (:math:`\omega`) range from the scales corresponding to the downscaling domain size to those associated with the downscaling resolution. We use the functional form: 

    .. figure:: img/hyde_rfarm/rfarm_eq3.png
        :alt: Rainfarm equation 3.
        :align: center


    By inverting the Fourier spectrum, , we obtain a Gaussian field defined on the whole range of scales between the domain size and the downscaling resolution, which we normalize to unit variance.

    5. Generation of a synthetic precipitation field, :math:`\hat{r}(x, y, t)`, by taking a nonlinear transformation of the Gaussian field :math:`q`. Here we use the simple transformation:

    .. figure:: img/hyde_rfarm/rfarm_eq4.png
        :alt: Rainfarm equation 4.
        :align: center

    which leads to a log-normal field :math:`\hat{r}`.

    6. We force the synthetic field to be equal to the original field :math:`P` when aggregated on the scales :math:`L_0, T_0` by defining a new field:

    .. figure:: img/hyde_rfarm/rfarm_eq5.png
        :alt: Rainfarm equation 5.
        :align: center

    Where :math:`\hat{R}` represents the field aggregated at the scale :math:`L_0, T_0`. When aggregated on space and time scales larger or equal to :math:`L_0` and to :math:`T_0`, the field behaves exactly as the original field :math:`P`. The stochastic nature of the downscaled field :math:`r`  is associated with the choice of the set of random Fourier phases. By choosing different sets of random Fourier phases, one can generate a large number of stochastic fields which are all equal to :math:`P` when aggregated on space and time scales larger than  :math:`L_0` and  :math:`T_0`, and which are different, but with similar statistical properties, on smaller scales.














    